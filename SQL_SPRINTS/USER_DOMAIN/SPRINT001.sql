CREATE SCHEMA "USER";
CREATE TABLE IF NOT EXISTS "USER"."DEPARTMENT" (
	"ID" BIGSERIAL CHECK ("ID" > 0) PRIMARY KEY,
	"NAME" VARCHAR(64) NOT NULL UNIQUE,
	"IS_ACTIVE" BOOLEAN NOT NULL DEFAULT TRUE,
	"CREATED_AT" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	"UPDATED_AT" TIMESTAMP NULL DEFAULT NULL,
	"DISABLED_AT" TIMESTAMP NULL DEFAULT NULL
);

DROP TYPE IF EXISTS "USER".USER_ROLE CASCADE;
DROP TYPE IF EXISTS "USER".USER_SUBROLE CASCADE;
CREATE TYPE "USER".USER_ROLE AS ENUM('EVENT_OPENER','QUALITY_INSPECTOR','RNC_REPORTER','IT_MANAGER');
CREATE TYPE "USER".USER_SUBROLE AS ENUM('ADMIN','USER');

CREATE TABLE IF NOT EXISTS "USER"."USER" (
	"ID" BIGSERIAL CHECK ("ID" > 0) PRIMARY KEY,
	"DEPARTMENT_ID" BIGINT NOT NULL,
	"LOGIN" VARCHAR(32) NOT NULL UNIQUE,
	"NAME" VARCHAR(128) NOT NULL,
	"NICKNAME" VARCHAR(64) NOT NULL,
	"EMAIL" VARCHAR(256) NOT NULL UNIQUE,
	"PASSWORD" VARCHAR(72) NOT NULL,
	"ROLE" "USER".USER_ROLE NOT NULL,
	"SUBROLE" "USER".USER_SUBROLE NOT NULL,
	"IS_ACTIVE" BOOLEAN NOT NULL DEFAULT TRUE,
	"FIRST_ACCESS" BOOLEAN NOT NULL DEFAULT TRUE,
	"LAST LOGIN_AT" TIMESTAMP DEFAULT NULL,
	"AVATAR_ID" VARCHAR DEFAULT NULL,
	"CREATED_AT" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	"UPDATED_AT" TIMESTAMP DEFAULT NULL,
	"DISABLED_AT" TIMESTAMP DEFAULT NULL
);

ALTER TABLE "USER"."USER" DROP CONSTRAINT IF EXISTS "USER_FK_DEPARTMENT_ID";
ALTER TABLE "USER"."USER" ADD CONSTRAINT "USER_FK_DEPARTMENT_ID" FOREIGN KEY ("DEPARTMENT_ID") REFERENCES "USER"."DEPARTMENT"("ID");